<?php
session_start();
require_once 'backend/config.php'; // DB connection using PDO
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CVA Bulletin Admin Dashboard | Cornerstones Vision Academy</title>
  <meta name="description" content="Admin dashboard for managing blogger registrations and article approvals at CVA Bulletin." />
  <meta name="keywords" content="CVA Bulletin, admin dashboard, blogger approval, article moderation, Cornerstones Vision Academy" />
  <meta name="author" content="Cornerstones Vision Academy" />

  <!-- Styles -->
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="../css/bulletin-dark.css" />

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" />
</head>
<body class="bulletin-dark">

  <!-- ================= HEADER ================= -->
  <header class="main-header">
    <nav class="navbar">
      <div class="logo"><a href="../index.html">Cornerstones Vision Academy</a></div>
      <ul class="nav-menu">
        <li><a href="../index.html">Home</a></li>
        <li><a href="../about.html">About</a></li>
        <li><a href="../academics.html">Academics</a></li>
        <li><a href="index.html">CVA Bulletin</a></li>
        <li><a href="dashboard-dark.php" class="active btn-outline">Dashboard</a></li>
        <li><a href="../contact.html">Contact</a></li>
      </ul>
    </nav>
  </header>

  <!-- ================= HERO ================= -->
  <section class="bulletin-hero" style="background-image: url('../images/bulletin-hero-2.jpg');">
    <div class="bulletin-hero-overlay"></div>
    <div class="bulletin-hero-content">
      <h1>Admin Dashboard</h1>
      <p class="subtitle">Manage Blogger Registrations & Article Approvals</p>
    </div>
  </section>

  <!-- ================= MAIN CONTENT ================= -->
  <main class="container dashboard-container">

    <!-- ================= ADMIN FEEDBACK ================= -->
    <?php if(!empty($_SESSION['success'])): ?>
      <div class="admin-alert success"><?= htmlspecialchars($_SESSION['success']); unset($_SESSION['success']); ?></div>
    <?php elseif(!empty($_SESSION['error'])): ?>
      <div class="admin-alert error"><?= htmlspecialchars($_SESSION['error']); unset($_SESSION['error']); ?></div>
    <?php endif; ?>

    <!-- ================= PENDING BLOGGERS ================= -->
    <section class="dashboard-section">
      <h2>Pending Blogger Registrations</h2>
      <table class="dashboard-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Username</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <?php
          $stmt = $pdo->query("SELECT id, name, email, role, username, status FROM bloggers WHERE status='Pending' ORDER BY id ASC");
          while ($blogger = $stmt->fetch(PDO::FETCH_ASSOC)):
          ?>
          <tr>
            <td><?= htmlspecialchars($blogger['name']) ?></td>
            <td><?= htmlspecialchars($blogger['email']) ?></td>
            <td><?= htmlspecialchars($blogger['role']) ?></td>
            <td><?= htmlspecialchars($blogger['username']) ?></td>
            <td><?= htmlspecialchars($blogger['status']) ?></td>
            <td class="actions">
              <form action="backend/blogger-actions.php" method="POST" class="inline-form">
                <input type="hidden" name="user_id" value="<?= $blogger['id'] ?>">
                <button type="submit" name="action" value="approve" class="btn-primary">Approve</button>
                <button type="submit" name="action" value="delete" class="btn-delete">Delete</button>
              </form>
            </td>
          </tr>
          <?php endwhile; ?>
        </tbody>
      </table>
    </section>

    <!-- ================= PENDING ARTICLES ================= -->
    <section class="dashboard-section">
      <h2>Pending Article Submissions</h2>
      <table class="dashboard-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Author</th>
            <th>Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <?php
          $stmt = $pdo->query("SELECT a.id, a.title, a.status, a.created_at, b.name AS author_name 
                               FROM articles a 
                               JOIN bloggers b ON a.author_id = b.id
                               WHERE a.status='Pending'
                               ORDER BY a.created_at DESC");
          while($article = $stmt->fetch(PDO::FETCH_ASSOC)):
          ?>
          <tr>
            <td><?= htmlspecialchars($article['title']) ?></td>
            <td><?= htmlspecialchars($article['author_name']) ?></td>
            <td><?= date('M d, Y', strtotime($article['created_at'])) ?></td>
            <td><?= htmlspecialchars($article['status']) ?></td>
            <td class="actions">
              <button class="btn-readmore" data-article-id="<?= $article['id'] ?>">Read More</button>
              <form action="backend/article-actions.php" method="POST" class="inline-form">
                <input type="hidden" name="article_id" value="<?= $article['id'] ?>">
                <button type="submit" name="action" value="approve" class="btn-primary">Approve</button>
                <button type="submit" name="action" value="delete" class="btn-delete">Delete</button>
                <button type="submit" name="action" value="feature" class="btn-feature">Feature</button>
              </form>
            </td>
          </tr>
          <?php endwhile; ?>
        </tbody>
      </table>
    </section>

  </main>

  <!-- ================= FOOTER ================= -->
  <footer class="main-footer dark-footer">
    <div class="container">
      <p>&copy; <?= date('Y') ?> Cornerstones Vision Academy. All Rights Reserved.</p>
    </div>
  </footer>

  <!-- ================= READ MORE MODAL ================= -->
  <div id="readMoreModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <button class="close-btn" aria-label="Close">&times;</button>
      <h3 id="modalTitle"></h3>
      <p id="modalContent"></p>
    </div>
  </div>

  <!-- ================= SCRIPTS ================= -->
  <script>
    const modal = document.getElementById('readMoreModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    const closeBtn = document.querySelector('.close-btn');

    document.querySelectorAll('.btn-readmore').forEach(btn => {
      btn.addEventListener('click', () => {
        const articleId = btn.dataset.articleId;
        fetch(`backend/fetch-article.php?id=${articleId}`)
          .then(res => res.json())
          .then(data => {
            if(data.error) {
              alert(data.error);
              return;
            }
            modalTitle.textContent = data.title;
            modalContent.textContent = data.content;
            modal.setAttribute('aria-hidden','false');
            modal.style.display = "block";
          })
          .catch(err => console.error("Fetch article error:", err));
      });
    });

    closeBtn.addEventListener('click', () => {
      modal.style.display = "none";
      modal.setAttribute('aria-hidden','true');
    });

    window.addEventListener('click', e => {
      if(e.target === modal) {
        modal.style.display = "none";
        modal.setAttribute('aria-hidden','true');
      }
    });
  </script>

</body>
</html>
